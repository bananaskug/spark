<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spark</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
<link rel="icon" href="https://raw.githubusercontent.com/bananaskug/sparkvids/main/sparklogo.png">
<style>
  body { margin:0; padding:0; background:#000; color:#fff; font-family:Arial,sans-serif; overflow:hidden; }
  nav { display:flex; justify-content:space-around; padding:10px; background:#111; border-bottom:1px solid #333; position:fixed; top:0; left:0; right:0; z-index:10; }
  nav a { color:#fff; text-decoration:none; font-size:28px; cursor:pointer; }

  #video-feed {
    padding-top:60px;
    height:100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
  }

  .video-container {
    position: relative;
    width: 100%;
    height: 100vh;
    scroll-snap-align: start;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background:#000;
  }

  .video-container video {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    background:#000;
  }

  .video-info {
    position: absolute;
    bottom: 80px;
    left: 20px;
    color: #fff;
    text-shadow: 0 0 8px rgba(0,0,0,0.9);
    z-index: 5;
  }
  .video-info h3 { margin:0; font-size:20px; font-weight:bold; }
  .video-info p { margin:5px 0 0; font-size:14px; opacity:0.9; }

  .uploader { display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; }
  .uploader img { width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #fff; }
  .uploader span { font-weight:bold; font-size:16px; }

  .sidebar {
    position:absolute;
    bottom:120px;
    right:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
    z-index:6;
  }
  .sidebar button {
    background:none;
    border:none;
    color:#fff;
    cursor:pointer;
    font-size:32px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:5px;
    text-shadow: 1px 1px 3px #000; /* black shadow */
  }
  .sidebar span { font-size:14px; }

  #comments-modal {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 60%;
    background: #111;
    border-radius: 12px 12px 0 0;
    display: none;
    flex-direction: column;
    z-index: 30;
  }
  #comments-header { padding: 10px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; }
  #comments-list { flex:1; overflow-y:auto; padding:10px; }
  .comment { display:flex; gap:10px; align-items:flex-start; padding:8px 0; border-bottom:1px solid #222; }
  .comment img { width:32px; height:32px; border-radius:50%; cursor:pointer; }
  .comment-content { flex:1; }
  .comment strong { color:#fff; cursor:pointer; }
  .comment small { color:#aaa; font-size:12px; display:block; margin-top:2px; }
  #comment-input-area { display:flex; padding:10px; border-top:1px solid #333; }
  #comment-input { flex:1; padding:8px; border-radius:6px; border:none; background:#222; color:#fff; }
  #send-comment { margin-left:10px; background:#007aff; border:none; border-radius:6px; padding:8px 12px; color:#fff; cursor:pointer; }

  #tap-overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    color:#fff;
    display:none;
    justify-content:center;
    align-items:center;
    font-size:22px;
    z-index:50;
    cursor:pointer;
  }
</style>
</head>
<body>
<nav>
    <a href="index.html" class="nav-icon material-symbols-rounded">home</a>
    <a href="upload.html" class="nav-icon material-symbols-rounded">add_circle</a>
    <a href="account.html" class="nav-icon material-symbols-rounded">account_circle</a>
</nav>

<div id="video-feed"></div>

<div id="comments-modal">
  <div id="comments-header">Comments <button onclick="document.getElementById('comments-modal').style.display='none';" style="float:right;background:none;border:none;color:#fff;cursor:pointer;">✕</button></div>
  <div id="comments-list"></div>
  <div id="comment-input-area">
    <input id="comment-input" placeholder="Add a comment..." />
    <button id="send-comment">Send</button>
  </div>
</div>

<div id="tap-overlay">⏸</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, increment, arrayUnion, arrayRemove, addDoc, query, orderBy, getDocs as getDocsSub, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDrhxEA1JT513op42cJHnoWx7nvlpmcMwE",
  authDomain: "spark-e4543.firebaseapp.com",
  projectId: "spark-e4543",
  storageBucket: "spark-e4543.firebasestorage.app",
  messagingSenderId: "26655443387",
  appId: "1:26655443387:web:338dc235c607650a389c9e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, user => currentUser = user);

let openVideoId = null;

// Format "time ago"
function timeAgo(ts){
  if(!ts) return "";
  const now = new Date();
  const sec = Math.floor((now - ts.toDate())/1000);
  if(sec<60) return `${sec}s ago`;
  if(sec<3600) return `${Math.floor(sec/60)}m ago`;
  if(sec<86400) return `${Math.floor(sec/3600)}h ago`;
  return `${Math.floor(sec/86400)}d ago`;
}

async function loadFYP() {
  const querySnap = await getDocs(collection(db,"videos"));
  let videos = [];
  querySnap.forEach(docSnap => videos.push({...docSnap.data(), id: docSnap.id}));

  // Shuffle
  for(let i=videos.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [videos[i],videos[j]]=[videos[j],videos[i]];
  }

  const feed = document.getElementById("video-feed");
  feed.innerHTML="";
  videos.forEach((v, index) => {
    const container = document.createElement("div");
    container.className = "video-container";

    const vid = document.createElement("video");
    vid.src = v.videoURL;
    vid.controls = false;
    vid.loop = true;
    vid.muted = false;
    vid.autoplay = index===0;
    vid.preload = "auto";

    if (index===0) {
      vid.play().catch(() => {
        document.getElementById("tap-overlay").style.display="flex";
      });
    }

    const info = document.createElement("div");
    info.className = "video-info";
    info.innerHTML = `
      <div class="uploader" data-user="${v.uploaderUsername}">
        <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(v.uploaderUsername)}" alt="pfp">
        <span>@${v.uploaderUsername || "unknown"}</span>
      </div>
      <h3>${v.title || "Untitled"}</h3>
      <p>${v.description || ""}</p>
    `;

    info.querySelector(".uploader").onclick = () => {
      window.location.href = "user.html?user=" + encodeURIComponent(v.uploaderUsername);
    };

    const sidebar = document.createElement("div");
    sidebar.className = "sidebar";
    sidebar.innerHTML = `
      <button class="like-btn material-symbols-rounded">
        favorite
        <span>${v.likes || 0}</span>
      </button>
      <button class="comment-btn material-symbols-rounded">
        chat
        <span>${v.commentCount || 0}</span>
      </button>
    `;

    const likeBtn = sidebar.querySelector(".like-btn");
    likeBtn.onclick = async () => {
      if(!currentUser) return;
      const videoRef = doc(db,"videos",v.id);
      if(v.likedBy && v.likedBy.includes(currentUser.email)){
        await updateDoc(videoRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.email) });
        v.likes--;
        v.likedBy = v.likedBy.filter(e=>e!==currentUser.email);
      }else{
        await updateDoc(videoRef, { likes: increment(1), likedBy: arrayUnion(currentUser.email) });
        v.likes=(v.likes||0)+1;
        v.likedBy=[...(v.likedBy||[]),currentUser.email];
      }
      likeBtn.querySelector("span").textContent=v.likes;
    };

    const commentBtn = sidebar.querySelector(".comment-btn");
    commentBtn.onclick = ()=>{ openComments(v.id, commentBtn.querySelector("span")); };

    container.appendChild(vid);
    container.appendChild(info);
    container.appendChild(sidebar);
    feed.appendChild(container);
  });

  handleScroll(feed);
}

async function openComments(videoId, counterEl){
  openVideoId = videoId;
  const modal=document.getElementById("comments-modal");
  const list=document.getElementById("comments-list");
  modal.style.display="flex";
  list.innerHTML="Loading...";

  const q=query(collection(db,"videos",videoId,"comments"),orderBy("createdAt","asc"));
  const snap=await getDocsSub(q);
  list.innerHTML="";
  let count=0;
  snap.forEach(docSnap=>{
    count++;
    const c=docSnap.data();
    const div=document.createElement("div");
    div.className="comment";
    div.innerHTML=`
      <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(c.username)}" alt="pfp">
      <div class="comment-content">
        <strong>@${c.username||"anon"}</strong> ${c.text}
        <small>${timeAgo(c.createdAt)}</small>
      </div>
    `;
    div.querySelector("img").onclick=()=>{ window.location.href="user.html?user="+encodeURIComponent(c.username); };
    div.querySelector("strong").onclick=()=>{ window.location.href="user.html?user="+encodeURIComponent(c.username); };
    list.appendChild(div);
  });
  if(counterEl) counterEl.textContent=count;

  document.getElementById("send-comment").onclick = async () => {
    if(!currentUser) return;
    const input=document.getElementById("comment-input");
    if(!input.value.trim()) return;
    await addDoc(collection(db,"videos",videoId,"comments"),{
      text: input.value,
      username: currentUser.displayName || currentUser.email.split("@")[0],
      createdAt: serverTimestamp()
    });
    input.value="";
    openComments(videoId, counterEl);
  };
}

// Scroll handling
function handleScroll(feed){
  const videos = feed.querySelectorAll("video");
  let current = videos[0];
  videos.forEach(v=>{ if(v!==current){ v.pause(); v.muted=true; } });

  function playVideo(video){
    videos.forEach(v=>{
      if(v===video){
        v.muted=false;
        v.play().catch(()=>{});
      } else {
        v.pause();
        v.muted=true;

        // 🔹 Restart when leaving
        v.currentTime = 0;
      }
    });
    current = video;
  }

  feed.addEventListener("scroll",()=>{
    const center = window.innerHeight/2;
    let closest = videos[0], minDistance=Infinity;
    videos.forEach(v=>{
      const rect=v.getBoundingClientRect();
      const vc=rect.top+rect.height/2;
      const dist=Math.abs(center-vc);
      if(dist<minDistance){ minDistance=dist; closest=v; }
    });
    if(current!==closest) playVideo(closest);
  });
}

// overlay click to unlock audio
document.getElementById("tap-overlay").addEventListener("click", () => {
  const firstVid=document.querySelector("video");
  if(firstVid){ firstVid.muted=false; firstVid.play().catch(()=>{}); }
  document.getElementById("tap-overlay").style.display="none";
});

loadFYP();
</script>
</body>
</html>