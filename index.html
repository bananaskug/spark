async function loadComments(videoId, container) {<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spark</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
<link rel="icon" href="https://raw.githubusercontent.com/bananaskug/sparkvids/main/sparklogo.png">
<style>
  body { margin:0; padding:0; background:#000; color:#fff; font-family:Arial,sans-serif; overflow:hidden; }
  nav { display:flex; justify-content:space-around; padding:10px; background:#111; border-bottom:1px solid #333; position:fixed; top:0; left:0; right:0; z-index:10; }
  nav a { color:#fff; text-decoration:none; font-size:28px; cursor:pointer; }
  #video-feed { padding-top:60px; height:100vh; overflow-y:auto; scroll-behavior:smooth; display:flex; flex-direction:column; align-items:center; gap:20px; }
  .video-container {
    position: relative;
    width: 100%;
    max-width: 1080px;
    height: 1920px;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
  }
  .video-container video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
  }
  .video-gradient {
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    height:250px;
    background:linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
    pointer-events:none;
  }
  .video-info {
    position: absolute;
    bottom: 100px;
    left: 20px;
    right: 100px;
    color: #fff;
    text-shadow: 0px 0px 8px rgba(0,0,0,0.9);
    z-index:5;
  }
  .video-info h3 { margin: 0; font-size: 20px; font-weight: bold; }
  .video-info p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }
  .uploader { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .uploader img { width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #fff; }
  .uploader span { font-weight:bold; font-size:16px; }
  .sidebar {
    position:absolute;
    bottom:120px;
    right:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
    z-index:6;
  }
  .sidebar button {
    background:none;
    border:none;
    color:#fff;
    cursor:pointer;
    font-size:32px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:5px;
  }
  .sidebar span { font-size:14px; }
  #unmute-btn {
    position:fixed;
    bottom:20px;
    right:20px;
    padding:15px 25px;
    font-size:16px;
    background:#007aff;
    color:#fff;
    border:none;
    border-radius:10px;
    cursor:pointer;
    z-index:20;
  }
  /* Comments modal */
  #comments-modal {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 60%;
    background: #111;
    border-radius: 12px 12px 0 0;
    display: none;
    flex-direction: column;
    z-index: 30;
  }
  #comments-header {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #333;
    font-weight: bold;
  }
  #comments-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .comment {
    padding: 5px 0;
    border-bottom: 1px solid #222;
  }
  .comment strong { color: #fff; }
  .comment small { color: #aaa; font-size: 12px; }
  #comment-input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #333;
  }
  #comment-input {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: none;
    background: #222;
    color: #fff;
  }
  #send-comment {
    margin-left: 10px;
    background: #007aff;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    color: #fff;
    cursor: pointer;
  }
  .nav-icon { cursor:pointer; font-size:28px; color: #fff; text-decoration: none;}
</style>
</head>
<body>
<nav>
    <a href="index.html" class="nav-icon material-symbols-rounded">home</a>
    <a href="upload.html" class="nav-icon material-symbols-rounded">add_circle</a>
    <a href="account.html" class="nav-icon material-symbols-rounded">account_circle</a>
</nav>

<div id="video-feed"></div>
<button id="unmute-btn">Unmute</button>

<!-- Comments modal -->
<div id="comments-modal">
  <div id="comments-header">Comments</div>
  <div id="comments-list"></div>
  <div id="comment-input-area">
    <input id="comment-input" placeholder="Add a comment..." />
    <button id="send-comment">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, increment, arrayUnion, arrayRemove, addDoc, query, orderBy, getDocs as getDocsSub } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDrhxEA1JT513op42cJHnoWx7nvlpmcMwE",
  authDomain: "spark-e4543.firebaseapp.com",
  projectId: "spark-e4543",
  storageBucket: "spark-e4543.firebasestorage.app",
  messagingSenderId: "26655443387",
  appId: "1:26655443387:web:338dc235c607650a389c9e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, user=>{
  currentUser = user;
});

let openVideoId = null;

async function loadFYP() {
  const querySnap = await getDocs(collection(db,"videos"));
  let videos = [];
  querySnap.forEach(docSnap => videos.push({...docSnap.data(), id: docSnap.id}));

  // Shuffle
  for(let i=videos.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [videos[i],videos[j]]=[videos[j],videos[i]];
  }

  const feed = document.getElementById("video-feed");
  feed.innerHTML="";
  videos.forEach((v,index)=>{
    const container = document.createElement("div");
    container.className = "video-container";

    const vid=document.createElement("video");
    vid.src=v.videoURL;
    vid.controls=false;
    vid.loop=true;
    vid.muted=true;
    vid.autoplay=index===0;
    vid.preload="metadata";
    vid.addEventListener("click",()=>{ if(vid.paused) vid.play(); else vid.pause(); });

    const gradient=document.createElement("div");
    gradient.className="video-gradient";

    const info=document.createElement("div");
    info.className="video-info";
    info.innerHTML = `
      <div class="uploader">
        <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(v.uploaderEmail)}" alt="pfp">
        <span>@${v.uploaderUsername || "unknown"}</span>
      </div>
      <h3>${v.title || "Untitled"}</h3>
      <p>${v.description || ""}</p>
    `;

    // Sidebar
    const sidebar = document.createElement("div");
    sidebar.className = "sidebar";
    sidebar.innerHTML = `
      <button class="like-btn material-symbols-rounded">
        favorite
        <span>${v.likes || 0}</span>
      </button>
      <button class="comment-btn material-symbols-rounded">
        chat
        <span>0</span>
      </button>
    `;

    // Likes
    const likeBtn = sidebar.querySelector(".like-btn");
    likeBtn.onclick = async ()=>{
      if(!currentUser){ alert("Login to like"); return; }
      const videoRef = doc(db,"videos",v.id);
      if(v.likedBy && v.likedBy.includes(currentUser.email)){
        await updateDoc(videoRef,{
          likes: increment(-1),
          likedBy: arrayRemove(currentUser.email)
        });
        v.likes--;
        v.likedBy = v.likedBy.filter(e=>e!==currentUser.email);
      }else{
        await updateDoc(videoRef,{
          likes: increment(1),
          likedBy: arrayUnion(currentUser.email)
        });
        v.likes=(v.likes||0)+1;
        v.likedBy=[...(v.likedBy||[]),currentUser.email];
      }
      likeBtn.querySelector("span").textContent=v.likes;
    };

    // Comments
    const commentBtn = sidebar.querySelector(".comment-btn");
    commentBtn.onclick = ()=>{
      openComments(v.id);
    };

    container.appendChild(vid);
    container.appendChild(gradient);
    container.appendChild(info);
    container.appendChild(sidebar);
    feed.appendChild(container);
  });

  handleScroll(feed);
  showUnmute();
}

// Comments modal logic
async function openComments(videoId){
  openVideoId = videoId;
  const modal=document.getElementById("comments-modal");
  const list=document.getElementById("comments-list");
  modal.style.display="flex";
  list.innerHTML="Loading...";

  const q=query(collection(db,"videos",videoId,"comments"),orderBy("createdAt","asc"));
  const snap=await getDocsSub(q);
  list.innerHTML="";
  snap.forEach(docSnap=>{
    const c=docSnap.data();
    const div=document.createElement("div");
    div.className="comment";
    div.innerHTML=`<strong>@${c.username||"anon"}</strong> ${c.text}<br><small>${c.userEmail}</small>`;
    list.appendChild(div);
  });
}

document.getElementById("send-comment").onclick=async ()=>{
  if(!currentUser){ alert("Login to comment"); return; }
  if(!openVideoId) return;
  const input=document.getElementById("comment-input");
  const text=input.value.trim();
  if(!text) return;
  await addDoc(collection(db,"videos",openVideoId,"comments"),{
    text,
    userEmail: currentUser.email,
    username: currentUser.displayName || currentUser.email.split("@")[0],
    createdAt: new Date()
  });
  input.value="";
  openComments(openVideoId); // reload
};

function handleScroll(feed){
  const videos = feed.querySelectorAll("video");
  let current=null;
  let scrollTimeout;
  if(videos.length) current=videos[0];

  function playVideo(video){
    videos.forEach(v=>{
      if(v===video){ v.currentTime=0; v.play().catch(()=>{}); } else { v.pause(); }
    });
    current=video;
  }

  feed.addEventListener("scroll",()=>{
    clearTimeout(scrollTimeout);
    scrollTimeout=setTimeout(()=>{
      const center=window.innerHeight/2;
      let closest=videos[0],minDistance=Infinity;
      videos.forEach(v=>{
        const rect=v.getBoundingClientRect();
        const vc=rect.top+rect.height/2;
        const dist=Math.abs(center-vc);
        if(dist<minDistance){ minDistance=dist; closest=v; }
      });
      if(current!==closest) playVideo(closest);
    },50);
  });
}

function showUnmute(){
  const btn=document.getElementById("unmute-btn");
  btn.style.display="block";
  btn.onclick=()=>{
    document.querySelectorAll("video").forEach(v=>v.muted=false);
    btn.style.display="none";
  };
}

loadFYP();
</script>
</body>
</html>